<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <title>game</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <header class="banner large">
            <h1>mor!tz sein<br><span style='font-size:1rem'>&lt;html></span>tiktaktoe<span style='font-size:1rem'>&lt;/html></span></h1>
        </header>
        <div class="loading"></div>
        <div id="board" style="display:none;grid-template-columns:repeat(3,100px);gap:5px">
          <button data-i="0"></button>
          <button data-i="1"></button>
          <button data-i="2"></button>
          <button data-i="3"></button>
          <button data-i="4"></button>
          <button data-i="5"></button>
          <button data-i="6"></button>
          <button data-i="7"></button>
          <button data-i="8"></button>
        </div>
        
<script type="module">
import { Tik } from "../gameclasses.js";
import { getIP } from "../utils.js";
import { ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { db } from "../firebasedata.js";

function generateGameKey(length = 5) {
    const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    let key = "";
    for (let i = 0; i < length; i++) {
        key += chars[Math.floor(Math.random() * chars.length)];
    }
    return key;
}

const params = new URLSearchParams(location.search);
let sessionId = params.get("session");

const game = new Tik();
await game.init();

const IP = await getIP();

/* ðŸ”´ FALL 1: KEINE SESSION-ID â†’ MATCHMAKING */
if (!sessionId) {
    const sessionsRef = ref(db, `games/${game.id}/sessions`);
    const snap = await get(sessionsRef);

    let joinableSession = null;

    if (snap.exists()) {
        const sessions = snap.val();

        for (const [key, session] of Object.entries(sessions)) {
            const playerCount = Object.keys(session.players || {}).length;

            if (!session.started && playerCount < game.info.playerAmount) {
                joinableSession = key;
                break;
            }
        }
    }

    if (joinableSession) {
        // âœ… existierende Session nutzen
        location.href = `?session=${joinableSession}`;
    } else {
        // âŒ keine freie â†’ neue erstellen
        let key;
        while (true) {
            key = generateGameKey();
            const snap = await get(ref(db, `games/${game.id}/sessions/${key}`));
            if (!snap.exists()) break;
        }

        await set(ref(db, `games/${game.id}/sessions/${key}`), {
            players: {},
            started: false
        });

        location.href = `?session=${key}`;
    }
}

/* ðŸŸ¢ FALL 2: SESSION EXISTIERT â†’ SPIELER BEITRETEN */
else {
    const playerRef = ref(db, `games/${game.id}/sessions/${sessionId}/players`);
    const snap = await get(playerRef);
    if (!snap.exists() || (!Object.values(snap.val()).includes(IP) && Object.keys(snap.val() || {}).length < game.info.playerAmount)) {
        const used = Object.keys(snap.val() || {}).map(Number);

        let index = 0;
        while (used.includes(index)) index++;

        await set(
            ref(db, `games/${game.id}/sessions/${sessionId}/players/${index}`),
            IP
        );

        const sessionRef = ref(db, `games/${game.id}/sessions/${sessionId}`);

        onValue(sessionRef, snap => {
            const session = snap.val();
            if (!session) return;

            if (
                Object.keys(session.players || {}).length >= game.info.playerAmount &&
                !session.started
            ) {
                set(ref(db, `games/${game.id}/sessions/${sessionId}/started`), true);
            }

            if (session.started) {
                initGame(session);
            }
        });
    }
}
const boardEl = document.getElementById("board");
const cells = [...boardEl.querySelectorAll("button")];
let myIndex = null;

function initGame(session) {
    boardEl.style.display = "grid";

    // eigenen Spielerindex finden
    for (const [i, ip] of Object.entries(session.players)) {
        if (ip === IP) myIndex = Number(i);
    }

    // Initialisieren falls nicht vorhanden
    if (!session.board) {
        set(ref(db, `games/${game.id}/sessions/${sessionId}`), {
            ...session,
            board: Array(9).fill(""),
            turn: 0,
            winner: null
        });
    }

    // Listener
    onValue(ref(db, `games/${game.id}/sessions/${sessionId}`), snap => {
        const s = snap.val();
        if (!s) return;

        renderBoard(s);

        if (s.winner) {
            alert(s.winner === myIndex ? "Du hast gewonnen" : "Du hast verloren");
        }
    });
}

function renderBoard(session) {
    session.board.forEach((v, i) => {
        cells[i].textContent = v;
        cells[i].disabled =
            v !== "" ||
            session.turn !== myIndex ||
            session.winner !== null;
    });
}
cells.forEach(cell => {
    cell.onclick = async () => {
        const i = Number(cell.dataset.i);
        const sessionRef = ref(db, `games/${game.id}/sessions/${sessionId}`);
        const snap = await get(sessionRef);
        const s = snap.val();

        if (s.turn !== myIndex || s.board[i] !== "" || s.winner) return;

        const symbol = myIndex === 0 ? "X" : "O";
        s.board[i] = symbol;

        const win = checkWin(s.board);
        await set(sessionRef, {
            ...s,
            board: s.board,
            turn: win ? s.turn : 1 - s.turn,
            winner: win ? myIndex : null
        });
    };
});
function checkWin(b) {
    const w = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
    ];
    return w.some(([a,b1,c]) => b[a] && b[a] === b[b1] && b[a] === b[c]);
}

</script>


</body>
</html>
