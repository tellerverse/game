<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8">
        <title>game</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <header class="banner large">
            <h1>mor!tz sein<br><span style='font-size:1rem'>&lt;html></span>tiktaktoe<span style='font-size:1rem'>&lt;/html></span></h1>
        </header>
        <div class="loading"></div>

        
<script type="module">
import { Tik } from "../gameclasses.js";
import { getIP } from "../utils.js";
import { ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { db } from "../firebasedata.js";

function generateGameKey(length = 5) {
    const chars = "abcdefghijklmnopqrstuvwxyz0123456789";
    let key = "";
    for (let i = 0; i < length; i++) {
        key += chars[Math.floor(Math.random() * chars.length)];
    }
    return key;
}

const params = new URLSearchParams(location.search);
let sessionId = params.get("session");

const game = new Tik();
await game.init();

const IP = await getIP();

/* ðŸ”´ FALL 1: KEINE SESSION â†’ NEUE SESSION ERZEUGEN */
if (!sessionId) {
    const sessionsRef = ref(db, `games/${game.id}/sessions`);
    const snap = await get(sessionsRef);

    let joinableSession = null;

    if (snap.exists()) {
        const sessions = snap.val();

        for (const [key, session] of Object.entries(sessions)) {
            const playerCount = Object.keys(session.players || {}).length;

            if (
                !session.started &&
                playerCount < game.info.playerAmount
            ) {
                joinableSession = key;
                break;
            }
        }
    }

    // âœ… Beitreten, wenn mÃ¶glich
    if (joinableSession) {
        location.href = `?session=${joinableSession}`;
        return;
    }

    // âŒ sonst neue Session erstellen
    let key;
    while (true) {
        key = generateGameKey();
        const snap = await get(ref(db, `games/${game.id}/sessions/${key}`));
        if (!snap.exists()) break;
    }

    await set(ref(db, `games/${game.id}/sessions/${key}`), {
        players: {},
        started: false
    });

    location.href = `?session=${key}`;
}


/* ðŸŸ¢ FALL 2: SESSION EXISTIERT â†’ SPIELER BEITRETEN */
else {
    const playerRef = ref(db, `games/${game.id}/sessions/${sessionId}/players`);
    const snap = await get(playerRef);
    const used = Object.keys(snap.val() || {}).map(Number);

    let index = 0;
    while (used.includes(index)) index++;

    await set(ref(db, `games/${game.id}/sessions/${sessionId}/players/${index}`), IP);

    const sessionRef = ref(db, `games/${game.id}/sessions/${sessionId}`);

    onValue(sessionRef, snap => {
        const session = snap.val();
        if (!session) return;

        if (
            Object.keys(session.players || {}).length >= game.info.playerAmount &&
            !session.started
        ) {
            set(ref(db, `games/${game.id}/sessions/${sessionId}/started`), true);
        }

        if (session.started) {
            console.log("Session gestartet:", sessionId);
            // ðŸ‘‰ HIER echte Game-Initialisierung
        }
    });
}
</script>

</body>
</html>
