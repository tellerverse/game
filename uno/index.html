<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>UNO Multiplayer</title>
<link rel="stylesheet" href="../style.css">
<style>
button { font-size:1.4rem;margin:4px;padding:6px }
.active { outline:3px solid lime }
.card {
  width: 100px;
  height: 150px;
  margin: 5px;
  border-radius: 8px;
  background: var(--card-color, #ffffff);
  border: 3px solid #000000;
  color: rgb(0, 0, 0);
  font-size: 3rem;
  align-items: center;
  justify-content: center;
  text-align: center;
  display: flex;
  transition: transform 0.4s ease, left 0.4s ease, top 0.4s ease;
}
.card:hover {
  transform: scale(1.1);
  cursor: pointer;
  border: none;
  box-shadow: 0 0 10px #fff;
}
#game {
  position: relative;
  height: 80vh;
}

#center {
  position: absolute;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  gap: 40px;
}

#hand {
  position: absolute;
  bottom: 20px;
  left: 0;
  right: 0;

  display: grid;
  gap: 12px; /* fester Abstand zwischen allen Karten */
  justify-content: center; /* zentriert die Karten */
  grid-auto-rows: 1fr;
  padding: 0 12px;

  /* Maximal 8 Karten pro Reihe, feste Breite f√ºr Karten */
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
}

/* √úberlappung f√ºr mehrere Reihen */
#hand button {
  margin-top: -30px; /* zweite Reihe √ºberlappt leicht die erste */
  transition: transform 0.2s ease;
}
/* 
.card {
  width: 15vw;
  height: calc(15vw * 1.4);
  border-radius: 8px;
  border: 3px solid #000;
  font-size: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.4s ease, left 0.4s ease, top 0.4s ease;
} */
 /* ================= PLAYER BAR ================= */
 #playerBar {
   display: flex;
   justify-content: center;
   gap: 24px;
   margin: 12px 0;
 }

 .player {
   display: flex;
   flex-direction: column;
   align-items: center;
   font-size: 0.8rem;
   color: #aaa;
 }

 .player.active {
   color: white;
 }

 .stack {
   display: flex;
 }

 .stack .back {
   width: 26px;
   height: 38px;
   background: #333;
   border: 2px solid #000;
   border-radius: 4px;
   margin-left: -10px;
 }

 .player.playing .stack .back {
   background: #363;
   border: 2px solid #0f0;
 }

 .player.playing .you {
   color: #0f0;
 }

 .you {
   font-size: 1.5rem;
   margin-top: 2px;
   color: rgb(0, 0, 0);
 }

 /* ================= DIRECTION ================= */
 #direction {
   text-align: center;
   font-size: 1.2rem;
   margin-top: 6px;
 }
</style>
</head>
<body>
<header class="banner large">
  <h1>mor!tz<br><span style="font-size:1rem">&lt;html&gt;</span>uno<span style="font-size:1rem">&lt;/html&gt;</span></h1>
</header>
<div id="playerBar"></div>
<div id="game">
  <div id="center">
    <div id="drawPile" class="card">üÇ†</div>
    <div id="pile" class="card"></div>
  </div>

  <div id="hand"></div>
</div>

<button id="startBtn" style="display:none">Spiel starten</button>
<script type="module">
import { ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { db } from "../firebasedata.js";
import { getIP } from "../utils.js";

/* ================== CONFIG ================== */
const GAME_PATH = "games/uno/sessions";
const MAX_PLAYERS = 5;

/* ================== KARTEN ================== */
const COLORS = ["red","yellow","green","blue"];
const VALUES = ["0","1","2","3","4","5","6","7","8","9","‚è≠Ô∏è","üîÑÔ∏è","+2"];
const startBtn = document.getElementById("startBtn");
function createDeck() {
  const d = [];
  for (const c of COLORS) {
    for (const v of VALUES) {
      d.push({ color:c, value:v });
      if (v !== "0") d.push({ color:c, value:v });
    }
  }
  for (let i=0;i<4;i++) {
    d.push({ color:"wild", value:"wild" });
    d.push({ color:"wild", value:"+4" });
  }
  return shuffle(d);
}

const shuffle = a => a.sort(()=>Math.random()-0.5);

/* ================== SESSION ================== */
const IP = await getIP();
const params = new URLSearchParams(location.search);
let session = params.get("session");

function genKey(len=5){
  const c="abcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from({length:len},()=>c[Math.floor(Math.random()*c.length)]).join("");
}

if (!session) {
  const snap = await get(ref(db, GAME_PATH));
  let target=null;

  if (snap.exists()) {
    for (const [id,s] of Object.entries(snap.val())) {
      if (!s.started && Object.keys(s.players||{}).length < MAX_PLAYERS) {
        target=id; break;
      }
    }
  }

  if (!target) {
    target=genKey();
    await set(ref(db,`${GAME_PATH}/${target}`),{
      started:false,
      players:{}
    });
  }

  location.href=`?session=${target}`;
  throw "redirect";
}

const sessionRef = ref(db,`${GAME_PATH}/${session}`);
const snap = await get(sessionRef);
let data = snap.val();

/* ================== PLAYER ================== */
let myIndex = Object.entries(data.players||{})
  .find(([_,p])=>p.ip===IP)?.[0];

if (myIndex==null && Object.keys(data.players||{}).length < MAX_PLAYERS) {
  myIndex = Object.keys(data.players||{}).length;
  await set(ref(db,`${GAME_PATH}/${session}/players/${myIndex}`),{
    ip:IP,
    hand:[]
  });
}

myIndex = Number(myIndex);

/* ================== INIT ================== */
onValue(sessionRef, snap => {
  const s = snap.val();
  if (!s) return;

  const playerCount = Object.keys(s.players || {}).length;

  // Start-Button sichtbar?
  startBtn.style.display =
    !s.started && myIndex === 0 && playerCount >= 2
      ? "block"
      : "none";

  if (!s.started) return;
  render(s);
});

startBtn.onclick = async () => {
  const snap = await get(sessionRef);
  const s = snap.val();

  if (!s || s.started) return;
  if (myIndex !== 0) return;

  const deck = createDeck();
  const players = structuredClone(s.players);

  // üî¥ KRITISCHER FIX
  for (const p of Object.values(players)) {
    if (!Array.isArray(p.hand)) p.hand = [];
  }

  for (let i = 0; i < 7; i++) {
    for (const p of Object.values(players)) {
      p.hand.push(deck.pop());
    }
  }

  await set(sessionRef, {
    started: true,
    turn: 0,
    direction: 1,
    drawStack: 0,
    deck,
    topCard: deck.pop(),
    players,
    winner: null
  });
};
function animateToPile(cardEl) {
  const clone = cardEl.cloneNode(true);
  const start = cardEl.getBoundingClientRect();
  const end = document.getElementById("pile").getBoundingClientRect();

  clone.style.position = "fixed";
  clone.style.left = start.left + "px";
  clone.style.top = start.top + "px";
  clone.style.margin = "0";
  clone.style.zIndex = 1000;

  const rot = (Math.random() * 40 - 20).toFixed(1);

  document.body.appendChild(clone);

  requestAnimationFrame(() => {
    clone.style.left = end.left + "px";
    clone.style.top = end.top + "px";
    clone.style.transform = `rotate(${rot}deg) scale(1.1)`;
  });

  setTimeout(() => clone.remove(), 400);
}

/* ================== LOGIK ================== */
function canPlay(card, top) {
  return (
    card.color === top.color ||
    card.value === top.value ||
    card.color === "wild"
  );
}

async function playCard(i) {
  const snap = await get(sessionRef);
  const s = snap.val();
  if (s.turn !== myIndex || s.winner!=null) return;

  const me = s.players[myIndex];
  const card = me.hand[i];
  if (!canPlay(card,s.topCard)) return;

  me.hand.splice(i,1);
  s.topCard = card;

  if (card.value==="+2") s.drawStack+=2;
  if (card.value==="+4") s.drawStack+=4;
  if (card.value==="üîÑÔ∏è") s.direction*=-1;
  if (card.value==="‚è≠Ô∏è")
    s.turn = (s.turn + s.direction + Object.keys(s.players).length) % Object.keys(s.players).length;

  if (card.color==="wild")
    s.topCard.color = prompt("Farbe (red/yellow/green/blue)");

  if (me.hand.length===0) s.winner=myIndex;

  s.turn = (s.turn + s.direction + Object.keys(s.players).length) % Object.keys(s.players).length;
  await set(sessionRef,s);
}

async function drawCard() {
  const snap = await get(sessionRef);
  const s = snap.val();
  if (s.turn !== myIndex) return;

  const me = s.players[myIndex];
  const n = Math.max(1,s.drawStack||1);

  for (let i=0;i<n;i++) me.hand.push(s.deck.pop());
  s.drawStack=0;
  s.turn = (s.turn + s.direction + Object.keys(s.players).length) % Object.keys(s.players).length;

  await set(sessionRef,s);
}

function renderPlayerBar(s) {
  const bar = document.getElementById("playerBar");
  bar.innerHTML = "";

  const playerCount = Object.keys(s.players).length;

  for (let i = 0; i < playerCount; i++) {
    const p = document.createElement("div");
    p.className = "player" + (s.turn === i ? " playing" : "");

    const stack = document.createElement("div");
    stack.className = "stack";

    for (let c = 0; c < 3; c++) {
      const back = document.createElement("div");
      back.className = "back";
      stack.appendChild(back);
    }

    p.appendChild(stack);

    if (i === myIndex) {
      const you = document.createElement("div");
      you.className = "you";
      you.textContent = "You";
      p.appendChild(you);
    }

    bar.appendChild(p);
  }

  // Richtungspfeil
  let dir = document.getElementById("direction");
  if (!dir) {
    dir = document.createElement("div");
    dir.id = "direction";
    bar.after(dir);
  }

  dir.textContent = s.direction === 1 ? "‚û°Ô∏è" : "‚¨ÖÔ∏è";
}


/* ================== UI ================== */
function render(s) {
  renderPlayerBar(s);


  const pile = document.getElementById("pile");
  pile.textContent =`${s.topCard.value}`;
  pile.style.transform =
  `rotate(${(Math.random()*10-5).toFixed(1)}deg)`;
  pile.style.setProperty("--card-color",
    s.topCard.color==="red" ? "#ff4444" :
    s.topCard.color==="yellow" ? "#ffff66" :
    s.topCard.color==="green" ? "#66ff66" :
    s.topCard.color==="blue" ? "#6666ff" :
      "#ffffff"
    );

  const handEl = document.getElementById("hand");
  handEl.innerHTML="";

  s.players[myIndex].hand.forEach((c,i)=>{
    const b = document.createElement("button");
    b.className = "card";
    b.textContent = c.value;

    b.style.marginLeft = "0"; // optional, Grid k√ºmmert sich
    b.style.marginTop = "0";   // wird durch CSS gesteuert
    b.style.transform = `rotate(${(Math.random()*10).toFixed(1)}deg)`;
    b.style.fontFamily = "'Burbank', 'Reem Kufi'";
    b.style.zIndex = i;
    b.style.setProperty("--card-color",
      c.color==="red" ? "#ff4444" :
      c.color==="yellow" ? "#ffff66" :
      c.color==="green" ? "#66ff66" :
      c.color==="blue" ? "#6666ff" :
      "#ffffff"
    );
    if (canPlay(c,s.topCard) && s.turn===myIndex) b.classList.add("active");
    b.onclick = async () => {
      animateToPile(b);
      await playCard(i);
    };
    handEl.appendChild(b);
  });
}

document.getElementById("drawPile").onclick = drawCard;

</script>
</body>
</html>
