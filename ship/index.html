<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schiffe versenken</title>
<link rel="stylesheet" href="../style.css">

<style>
.board {
  display:grid;
  grid-template-columns:repeat(10,36px);
  gap:4px;
  justify-content:center;
  margin:30px auto;
}

.cell {
  width:36px;
  height:36px;
  border-radius:6px;
  background:linear-gradient(145deg,#0088dc,#9ed8ff);
}

.cell.ship { background:#4caf50 }
.cell.hit  { background:#e53935 }
.cell.miss { background:#555 }

#ships {
  display:flex;
  gap:10px;
  justify-content:center;
}

.ship {
  background:#4caf50;
  border-radius:6px;
  height:36px;
}

button {
  display:block;
  margin:20px auto;
  font-size:1.2rem;
}
</style>
</head>

<body>

<header class="banner large">
<h1>mor!tz<br>&lt;html&gt;schiffe&lt;/html&gt;</h1>
</header>

<div class="loading">warte auf spielerâ€¦</div>

<div id="ships"></div>
<button id="rotateBtn">ROTATE</button>
<button id="readyBtn" style="display:none">READY</button>

<div id="board" class="board" style="display:none"></div>

<script type="module">
import { ref,get,set,onValue } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { db } from "../firebasedata.js";
import { getIP } from "../utils.js";

/* ================= CONFIG ================= */

const SIZE = 10;
const SHIPS = [5,4,3,3,2];
let orientation = "h";

/* ================= UTILS ================= */

const other = i => i===0?1:0;
const genKey = (l=5)=>Array.from({length:l},()=>Math.random().toString(36)[2]).join("");

/* ================= SESSION ================= */

const IP = await getIP();
const params = new URLSearchParams(location.search);
let session = params.get("session");
const GAME_PATH = "games/ship/sessions";

if(!session){
  const snap = await get(ref(db,GAME_PATH));
  let target=null;
  if(snap.exists()){
    for(const [id,s] of Object.entries(snap.val())){
      if(!s.started && Object.keys(s.players||{}).length<2){
        target=id; break;
      }
    }
  }
  if(!target){
    target=genKey();
    await set(ref(db,`${GAME_PATH}/${target}`),{
      players:{},
      started:false,
      phase:"place",
      ready:{},
      activeBoard:0,
      turn:1
    });
  }
  location.href=`?session=${target}`;
  throw "redirect";
}

/* ================= JOIN ================= */

const sessionRef = ref(db,`${GAME_PATH}/${session}`);
const snap = await get(sessionRef);
const data = snap.val();

let myIndex=null;
for(const [i,ip] of Object.entries(data.players||{}))
  if(ip===IP) myIndex=+i;

if(myIndex===null){
  myIndex=Object.keys(data.players||{}).length;
  await set(ref(db,`${GAME_PATH}/${session}/players/${myIndex}`),IP);
}

/* ================= UI ================= */

const boardEl = document.getElementById("board");
const shipsEl = document.getElementById("ships");
const readyBtn = document.getElementById("readyBtn");
const rotateBtn = document.getElementById("rotateBtn");

const cells=[];
for(let i=0;i<100;i++){
  const c=document.createElement("div");
  c.className="cell";
  c.dataset.i=i;
  boardEl.appendChild(c);
  cells.push(c);
}

/* ================= PLACEMENT ================= */

let shipQueue=[...SHIPS];
let placedShips=[];

rotateBtn.onclick=()=>orientation=orientation==="h"?"v":"h";

cells.forEach(c=>{
  c.onclick=()=>{
    if(!shipQueue.length) return;
    const len=shipQueue[0];
    const start=+c.dataset.i;
    const list=[];

    for(let k=0;k<len;k++){
      const i=orientation==="h"?start+k:start+k*SIZE;
      if(i>=100) return;
      list.push(i);
    }

    list.forEach(i=>cells[i].classList.add("ship"));
    placedShips.push({cells:list});
    shipQueue.shift();

    if(!shipQueue.length) readyBtn.style.display="block";
  };
});

/* ================= READY ================= */

readyBtn.onclick=async()=>{
  await set(ref(db,`${GAME_PATH}/${session}/boards/${myIndex}`),{
    ships:placedShips,
    shots:"-".repeat(100)
  });
  await set(ref(db,`${GAME_PATH}/${session}/ready/${myIndex}`),true);
};

/* ================= RENDER ================= */

function renderBoard(s){
  cells.forEach(c=>c.className="cell");
  const b=s.boards[s.activeBoard];
  if(!b) return;

  if(s.activeBoard===myIndex){
    b.ships.forEach(ship=>ship.cells.forEach(i=>cells[i].classList.add("ship")));
  }

  b.shots.split("").forEach((v,i)=>{
    if(v==="x") cells[i].classList.add("hit");
    if(v==="o") cells[i].classList.add("miss");
  });
}

/* ================= GAME LOOP ================= */

onValue(sessionRef,async snap=>{
  const s=snap.val();
  if(!s) return;

  if(!s.started && Object.keys(s.ready||{}).length===2 && myIndex===0){
    await set(ref(db,`${GAME_PATH}/${session}/started`),true);
    await set(ref(db,`${GAME_PATH}/${session}/phase`),"fight");
  }

  if(!s.started) return;

  document.querySelector(".loading").style.display="none";
  boardEl.style.display="grid";
  shipsEl.style.display="none";
  rotateBtn.style.display="none";
  readyBtn.style.display="none";

  renderBoard(s);

  if(s.phase==="fight"){
    if(s.turn===myIndex && s.activeBoard!==myIndex){
      cells.forEach(c=>{
        c.onclick=async()=>{
          const i=+c.dataset.i;
          const board=structuredClone(s.boards[s.activeBoard]);
          if(board.shots[i]!=="-") return;

          const hit=board.ships.some(ship=>ship.cells.includes(i));
          board.shots=
            board.shots.slice(0,i)+(hit?"x":"o")+board.shots.slice(i+1);

          await set(ref(db,`${GAME_PATH}/${session}/boards/${s.activeBoard}`),board);

          if(!hit){
            await set(ref(db,`${GAME_PATH}/${session}/activeBoard`),myIndex);
            await set(ref(db,`${GAME_PATH}/${session}/turn`),other(myIndex));
          }
        };
      });
    }
  }
});
</script>
</body>
</html>
