<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schiffe versenken</title>
<link rel="stylesheet" href="../style.css">
<style>

#boards {
  display: flex;
  gap: 40px;
  justify-content: center;
  margin-top: 40px;
}

.board {
  display: grid;
  grid-template-columns: repeat(10, 36px);
  gap: 4px;
}

.cell {
  width: 36px;
  height: 36px;
  border-radius: 6px;
  background: linear-gradient(145deg,#0088dc,#9ed8ff);
  cursor: pointer;
}

.cell.ship { background:#4caf50 }
.cell.hit  { background:#e53935 }
.cell.miss { background:#555 }

#ships {
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:20px;
}

.ship {
  background:#4caf50;
  border-radius:6px;
  cursor:grab;
}

button {
  margin-top:20px;
  font-size:1.2rem;
}

</style>
</head>

<body>

<header class="banner large">
<h1>mor!tz<br>&lt;html&gt;schiffe&lt;/html&gt;</h1>
</header>

<div class="loading">warte auf spielerâ€¦</div>

<div id="ships"></div>
<button id="readyBtn" style="display:none">READY</button>

<div id="boards" style="display:none">
  <div>
    <h3>DEIN FELD</h3>
    <div id="myBoard" class="board"></div>
  </div>
  <div>
    <h3>GEGNER</h3>
    <div id="enemyBoard" class="board"></div>
  </div>
</div>

<script type="module">
import { ref,get,set,onValue } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { db } from "../firebasedata.js";
import { getIP } from "../utils.js";

/* ================= SETUP ================= */

const SIZE = 10;
const SHIPS = [5,4,3,3,2];
let orientation = "h";

document.addEventListener("keydown",e=>{
  if(e.key==="r") orientation = orientation==="h"?"v":"h";
});

const IP = await getIP();
const params = new URLSearchParams(location.search);
let session = params.get("session");
const GAME_PATH = "games/battleship/sessions";

/* ================= MATCHMAKING ================= */

function genKey(len=5){
  const c="abcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from({length:len},()=>c[Math.random()*c.length|0]).join("");
}

if(!session){
  const snap = await get(ref(db,GAME_PATH));
  let target=null;
  if(snap.exists()){
    for(const [id,s] of Object.entries(snap.val())){
      if(!s.started && Object.keys(s.players||{}).length<2){
        target=id; break;
      }
    }
  }
  if(!target){
    target=genKey();
    await set(ref(db,`${GAME_PATH}/${target}`),{
      players:{}, started:false, phase:"place",
      ready:{}, turn:0, winner:null
    });
  }
  location.href=`?session=${target}`;
  throw "redirect";
}

/* ================= JOIN ================= */

const sessionRef = ref(db,`${GAME_PATH}/${session}`);
const snap = await get(sessionRef);
const data = snap.val();

let myIndex=null;
for(const [i,ip] of Object.entries(data.players||{}))
  if(ip===IP) myIndex=+i;

if(myIndex==null){
  myIndex = Object.keys(data.players||{}).length;
  await set(ref(db,`${GAME_PATH}/${session}/players/${myIndex}`),IP);
}

/* ================= UI BUILD ================= */

const myBoardEl = document.getElementById("myBoard");
const enemyBoardEl = document.getElementById("enemyBoard");
const shipsEl = document.getElementById("ships");
const readyBtn = document.getElementById("readyBtn");

const myCells=[], enemyCells=[];

for(let i=0;i<100;i++){
  const a=document.createElement("div");
  a.className="cell";
  a.dataset.i=i;
  myBoardEl.appendChild(a);
  myCells.push(a);

  const b=document.createElement("div");
  b.className="cell";
  b.dataset.i=i;
  enemyBoardEl.appendChild(b);
  enemyCells.push(b);
}

/* ================= SHIP PLACEMENT ================= */

let placedShips=[];

for(const len of SHIPS){
  const s=document.createElement("div");
  s.className="ship";
  s.style.width = orientation==="h"?`${len*36}px`:"36px";
  s.style.height = orientation==="v"?`${len*36}px`:"36px";
  s.draggable=true;
  s.dataset.len=len;
  shipsEl.appendChild(s);

  s.ondragstart = e=>{
    e.dataTransfer.setData("len",len);
  };
}

myCells.forEach(c=>{
  c.ondragover=e=>e.preventDefault();
  c.ondrop=e=>{
    const len=+e.dataTransfer.getData("len");
    const start=+c.dataset.i;
    const cells=[];

    for(let k=0;k<len;k++){
      const r = orientation==="h" ? start+k : start+k*SIZE;
      if(r>=100) return;
      cells.push(r);
    }

    placedShips.push({cells,hits:Array(len).fill(false)});
    cells.forEach(i=>myCells[i].classList.add("ship"));
    shipsEl.innerHTML="";
    if(placedShips.length===SHIPS.length)
      readyBtn.style.display="block";
  };
});

/* ================= READY ================= */

readyBtn.onclick=async()=>{
  await set(ref(db,`${GAME_PATH}/${session}/boards/${myIndex}`),{
    ships:placedShips,
    shots:"-".repeat(100)
  });
  await set(ref(db,`${GAME_PATH}/${session}/ready/${myIndex}`),true);
};

/* ================= GAME LOOP ================= */

onValue(sessionRef,async snap=>{
  const s=snap.val();
  if(!s) return;

  if(!s.started && Object.keys(s.ready||{}).length===2 && myIndex===0){
    await set(ref(db,`${GAME_PATH}/${session}/started`),true);
    await set(ref(db,`${GAME_PATH}/${session}/phase`),"fight");
  }

  if(!s.started) return;

  document.querySelector(".loading").style.display="none";
  document.getElementById("boards").style.display="flex";

  if(s.phase==="fight"){
    enemyCells.forEach(c=>{
      c.onclick=async()=>{
        if(s.turn!==myIndex) return;
        const i=+c.dataset.i;
        const enemy = myIndex===0?1:0;
        const board=s.boards[enemy];
        if(board.shots[i]!=="-") return;

        board.shots = board.shots.substring(0,i)+"x"+board.shots.substring(i+1);
        await set(ref(db,`${GAME_PATH}/${session}/boards/${enemy}`),board);
        await set(ref(db,`${GAME_PATH}/${session}/turn`),enemy);
      };
    });
  }
});
</script>
</body>
</html>
