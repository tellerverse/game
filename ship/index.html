<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Schiffe versenken</title>

<style>
body { font-family:sans-serif; background:#0b1220; color:white; text-align:center }
.board {
  display:grid;
  grid-template-columns:repeat(10,36px);
  gap:4px;
  justify-content:center;
  margin:20px auto;
}
.cell {
  width:36px; height:36px;
  border-radius:6px;
  background:#1e90ff;
}
.cell.ship { background:#4caf50 }
#ships { display:flex; gap:10px; justify-content:center; margin-top:20px }
.ship {
  background:#4caf50;
  height:36px;
  border-radius:6px;
  touch-action:none;
}
button { font-size:1.2rem; margin-top:20px }
.hidden { display:none }
</style>
</head>

<body>

<h1>Schiffe versenken</h1>
<div id="status">warte…</div>

<div id="ships" class="hidden"></div>
<div id="board" class="board hidden"></div>
<button id="readyBtn" class="hidden">READY</button>

<script type="module">
import { ref,get,set,onValue } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { db } from "../firebasedata.js";
import { getIP } from "../utils.js";

/* ================= CONFIG ================= */

const SIZE = 10;
const SHIPS = [5,4,3,3,2];
const GAME_PATH = "games/ship/sessions";
const IP = await getIP();

/* ================= SESSION ================= */

const params = new URLSearchParams(location.search);
let session = params.get("session");

const genKey = () => Math.random().toString(36).slice(2,7);

if (!session) {
  const snap = await get(ref(db, GAME_PATH));
  let target = null;

  if (snap.exists()) {
    for (const [id,s] of Object.entries(snap.val())) {
      if (!s.started && Object.keys(s.players||{}).length < 2)
        target = id;
    }
  }

  if (!target) {
    target = genKey();
    await set(ref(db, `${GAME_PATH}/${target}`), {
      players:{}, started:false, phase:"place",
      ready:{}, activeBoard:0
    });
  }

  location.href = `?session=${target}`;
  throw "redirect";
}

/* ================= JOIN ================= */

const sessionRef = ref(db, `${GAME_PATH}/${session}`);
const snap = await get(sessionRef);
const data = snap.val();

let myIndex = null;
for (const [i,ip] of Object.entries(data.players||{}))
  if (ip === IP) myIndex = +i;

if (myIndex === null) {
  myIndex = Object.keys(data.players||{}).length;
  await set(ref(db, `${GAME_PATH}/${session}/players/${myIndex}`), IP);
}

/* ================= UI ================= */

const boardEl = document.getElementById("board");
const shipsEl = document.getElementById("ships");
const readyBtn = document.getElementById("readyBtn");
const statusEl = document.getElementById("status");

const cells = [];
for (let i=0;i<100;i++){
  const c=document.createElement("div");
  c.className="cell";
  c.dataset.i=i;
  boardEl.appendChild(c);
  cells.push(c);
}

/* ================= PLACEMENT ================= */

let placedShips = [];
let draggingShip = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

/* === SHIPS ERZEUGEN === */
SHIPS.forEach(len => {
  const ship = document.createElement("div");
  ship.className = "ship";
  ship.dataset.len = len;
  ship.dataset.rot = "h";
  ship.style.width = `${len * 36}px`;

  shipsEl.appendChild(ship);

  /* ROTATION PER KLICK */
  ship.onclick = e => {
    if (draggingShip) return;
    ship.dataset.rot = ship.dataset.rot === "h" ? "v" : "h";
    ship.style.width  = ship.dataset.rot === "h" ? `${len * 36}px` : "36px";
    ship.style.height = ship.dataset.rot === "v" ? `${len * 36}px` : "36px";
  };

  /* === DRAG START === */
  ship.addEventListener("pointerdown", e => {
    e.preventDefault();

    draggingShip = ship;
    ship.setPointerCapture(e.pointerId);

    const rect = ship.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    ship.style.position = "absolute";
    ship.style.zIndex = 1000;
  });

  /* === DRAG MOVE === */
  ship.addEventListener("pointermove", e => {
    if (!draggingShip) return;
    ship.style.left = `${e.clientX - dragOffsetX}px`;
    ship.style.top  = `${e.clientY - dragOffsetY}px`;
  });

  /* === DROP === */
  ship.addEventListener("pointerup", e => {
    if (!draggingShip) return;

    const rect = boardEl.getBoundingClientRect();
    const col = Math.floor((e.clientX - rect.left) / 40);
    const row = Math.floor((e.clientY - rect.top) / 40);

    if (col < 0 || row < 0 || col >= 10 || row >= 10) {
      resetShip(ship);
      return;
    }

    const start = row * 10 + col;
    const cellsIdx = [];

    for (let k = 0; k < len; k++) {
      const i = ship.dataset.rot === "h"
        ? start + k
        : start + k * 10;

      if (i >= 100) return resetShip(ship);
      cellsIdx.push(i);
    }

    cellsIdx.forEach(i => cells[i].classList.add("ship"));
    placedShips.push({ cells: cellsIdx });

    ship.remove();
    draggingShip = null;

    if (placedShips.length === SHIPS.length)
      readyBtn.classList.remove("hidden");
  });
});

function resetShip(ship) {
  ship.style.position = "relative";
  ship.style.left = "";
  ship.style.top = "";
  draggingShip = null;
}

/* ================= READY ================= */

readyBtn.onclick=async()=>{
  await set(ref(db,`${GAME_PATH}/${session}/boards/${myIndex}`),{
    ships:placedShips,
    shots:"-".repeat(100)
  });
  await set(ref(db,`${GAME_PATH}/${session}/ready/${myIndex}`),true);
  readyBtn.disabled=true;
};

/* ================= GAME LOOP ================= */

onValue(sessionRef, async snap=>{
  const s=snap.val();
  if(!s) return;

  /* started sobald 2 Spieler */
  if (!s.started && Object.keys(s.players||{}).length===2 && myIndex===0) {
    await set(ref(db,`${GAME_PATH}/${session}/started`),true);
  }

  if (!s.started) {
    statusEl.textContent="warte auf spieler…";
    return;
  }

  /* place-phase */
  if (s.phase==="place") {
    statusEl.textContent="Platziere deine Schiffe";
    shipsEl.classList.remove("hidden");
    boardEl.classList.remove("hidden");

    if (Object.keys(s.ready||{}).length===2 && myIndex===0) {
      await set(ref(db,`${GAME_PATH}/${session}/phase`),"fight");
      await set(ref(db,`${GAME_PATH}/${session}/activeBoard`),0);
    }
  }

  /* fight-phase */
  if (s.phase==="fight") {
    shipsEl.classList.add("hidden");
    readyBtn.classList.add("hidden");

    const showBoard = s.activeBoard;
    boardEl.classList.remove("hidden");

    statusEl.textContent =
      showBoard===myIndex ? "Dein Feld" : "Gegnerfeld";

    cells.forEach(c=>c.className="cell");

    const board = s.boards?.[showBoard];
    if (!board) return;

    if (showBoard===myIndex) {
      board.ships.forEach(sh =>
        sh.cells.forEach(i=>cells[i].classList.add("ship"))
      );
    }
  }
});
</script>
</body>
</html>
